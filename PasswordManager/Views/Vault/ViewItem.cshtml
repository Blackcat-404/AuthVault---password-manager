@using PasswordManager.ViewModels.Vault
@using PasswordManager.ViewModels.Vault.VaultItems
@model ViewItemViewModel

@{
    ViewData["Title"] = "View Item";
    Layout = "_VaultLayout";
    ViewData["EnablePasswordGenerator"] = true;

    var itemType = Model.Item switch
    {
        LoginItemViewModel => "Login",
        CardItemViewModel => "Card",
        NoteItemViewModel => "Note",
        _ => "Unknown"
    };

    var folders = Model.Folders;
}

<div class="vault-page">
    <div class="app-container">
        <main class="main-content">
            @Html.AntiForgeryToken()

            <!-- Header with back button -->
            <header class="header">
                <div class="header-left">
                    <a href="@Url.Action("Home", "Vault")" class="btn btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        Back to Vault
                    </a>
                </div>

                <div class="header-actions">
                    <form asp-action="DeleteItem" asp-controller="Vault" method="post" onsubmit="return confirmDelete()">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Item.Id" />
                        <input type="hidden" name="type" value="@itemType" />
                        <button type="submit" class="btn btn-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18" />
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                            </svg>
                            Delete Item
                        </button>
                    </form>
                </div>
            </header>

            <!-- Item details -->
            <div class="content-area">
                <div class="item-view-container">

                    <!-- Item icon and title -->
                    <div class="item-view-header">
                        @switch (Model.Item)
                        {
                            case LoginItemViewModel:
                                <div class="item-view-icon login">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                    </svg>
                                </div>
                                break;
                            case CardItemViewModel:
                                <div class="item-view-icon card">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect width="20" height="14" x="2" y="5" rx="2" />
                                        <line x1="2" x2="22" y1="10" y2="10" />
                                    </svg>
                                </div>
                                break;
                            case NoteItemViewModel:
                                <div class="item-view-icon note">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z" />
                                        <path d="M14 2v5a1 1 0 0 0 1 1h5" />
                                    </svg>
                                </div>
                                break;
                        }

                        <div class="item-view-title-section">
                            <div class="title-with-badge">
                                <!-- Edit Title -->
                                <div class="title-edit-wrapper" data-field="Title" data-id="@Model.Item.Id" data-type="@itemType">
                                    <h1 class="item-title">@Model.Item.Title</h1>
                                    <button class="title-edit-button" onclick="openEditTitleModal()" title="Edit title">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                            <path d="m15 5 4 4" />
                                        </svg>
                                    </button>
                                </div>
                                <span class="item-type-badge">@itemType</span>
                            </div>
                        </div>
                    </div>

                    <!-- Fields based on item type -->
                    <div class="item-view-fields">

                        @switch (Model.Item)
                        {
                            case LoginItemViewModel login:

                                <!-- Folder -->
                                <div class="field-group">
                                    <label class="field-label">Folder</label>
                                    <div class="editable-field" data-field="FolderId" data-id="@login.Id" data-type="Login">
                                        <!-- View Mode -->
                                        <div class="field-value-container">
                                            <span class="field-value">@(login.FolderName ?? "No Folder")</span>
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit folder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <!-- Edit Mode -->
                                        <div class="edit-mode-container" style="display:none">
                                            <select class="form-input edit-input" value="@login.FolderId">
                                                <option value="">No Folder</option>
                                                @foreach (var folder in folders)
                                                {
                                                    <option value="@folder.Key">@folder.Value</option>
                                                }
                                            </select>
                                            <div class="edit-actions">
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Username/Email -->
                                <div class="field-group">
                                    <label class="field-label">Username / Email</label>
                                    <div class="editable-field" data-field="Login" data-id="@login.Id" data-type="Login">
                                        <!-- View Mode -->
                                        <div class="field-value-container">
                                            <span class="field-value">@if (login.Login != null && login.Login.Any()){@string.Join(Environment.NewLine, login.Login)}else{<span class="text-muted">Not set</span>}</span>
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn copy-btn" onclick="copyToClipboard('@login.Login', 'Username')" title="Copy username">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                </svg>
                                            </button>
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit username">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <!-- Edit Mode -->
                                        <div class="edit-mode-container" style="display: none;">
                                            <input type="text" class="form-input edit-input" value="@login.Login" />
                                            <div class="edit-actions">
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Password -->
                                <div class="field-group">
                                    <label class="field-label">Password</label>
                                    <div class="editable-field editable-field-password" data-field="Password" data-id="@login.Id" data-type="Login">
                                        <!-- View Mode -->
                                        <div class="field-value-container">
                                            @if (string.IsNullOrEmpty(login.Password))
                                            {
                                                <span class="field-value"><span class="text-muted">Not set</span></span>
                                            }
                                            else
                                            {
                                                <input type="password" class="password-display-input" value="@login.Password" readonly tabindex="-1">
                                            }
                                        </div>
                                        <div class="field-actions">
                                            @if (!string.IsNullOrEmpty(login.Password))
                                            {
                                                <button type="button" class="field-action-btn toggle-btn" onclick="togglePasswordVisibility(this, true)" title="Toggle password visibility">
                                                    <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="m15 18-.722-3.25" />
                                                        <path d="M2 8a10.645 10.645 0 0 0 20 0" />
                                                        <path d="m20 15-1.726-2.05" />
                                                        <path d="m4 15 1.726-2.05" />
                                                        <path d="m9 18 .722-3.25" />
                                                    </svg>
                                                    <svg class="eye-open" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn copy-btn" onclick="copyToClipboard('@login.Password', 'Password')" title="Copy password">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                    </svg>
                                                </button>
                                            }
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit password">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <!-- Edit Mode -->
                                        <div class="edit-mode-container password-edit-mode" style="display: none;">
                                            <div class="password-input-group">
                                                <input type="password" class="form-input edit-input edit-password-input" value="@(login.Password ?? "")">
                                                <button type="button" class="field-action-btn toggle-btn" onclick="togglePasswordVisibility(this, false)" title="Toggle password visibility">
                                                    <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="m15 18-.722-3.25" />
                                                        <path d="M2 8a10.645 10.645 0 0 0 20 0" />
                                                        <path d="m20 15-1.726-2.05" />
                                                        <path d="m4 15 1.726-2.05" />
                                                        <path d="m9 18 .722-3.25" />
                                                    </svg>
                                                    <svg class="eye-open" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                                        <circle cx="12" cy="12" r="3" />
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn generate-btn" onclick="openPasswordGenerator(this)" title="Generate password">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M11 10.27 7 3.34" />
                                                        <path d="m11 13.73-4 6.93" />
                                                        <path d="M12 22v-2" />
                                                        <path d="M12 2v2" />
                                                        <path d="M14 12h8" />
                                                        <path d="m17 20.66-1-1.73" />
                                                        <path d="m17 3.34-1 1.73" />
                                                        <path d="M2 12h2" />
                                                        <path d="m20.66 17-1.73-1" />
                                                        <path d="m20.66 7-1.73 1" />
                                                        <path d="m3.34 17 1.73-1" />
                                                        <path d="m3.34 7 1.73 1" />
                                                        <circle cx="12" cy="12" r="2" />
                                                        <circle cx="12" cy="12" r="8" />
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- URL -->
                                <div class="field-group">
                                    <label class="field-label">Website URL</label>
                                    <div class="editable-field" data-field="WebURL" data-id="@login.Id" data-type="Login">
                                        <!-- View Mode -->
                                        <div class="field-value-container">
                                            @if (string.IsNullOrEmpty(login.WebURL))
                                            {
                                                <span class="field-value"><span class="text-muted">Not set</span></span>
                                            }
                                            else
                                            {
                                                <a href="@(login.WebURL.StartsWith("http://") || login.WebURL.StartsWith("https://") ? login.WebURL : "https://" + login.WebURL)"
                                                   target="_blank"
                                                   class="field-value link"
                                                   rel="noopener noreferrer">@login.WebURL</a>
                                            }
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn copy-btn" onclick="copyToClipboard('@login.WebURL', 'URL')" title="Copy URL">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                </svg>
                                            </button>
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit URL">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <!-- Edit Mode -->
                                        <div class="edit-mode-container" style="display: none;">
                                            <input type="url" class="form-input edit-input" value="@(login.WebURL ?? "")" />
                                            <div class="edit-actions">
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="field-group">
                                    <label class="field-label">Notes</label>
                                    <div class="editable-field editable-field-textarea" data-field="Note" data-id="@login.Id" data-type="Login">
                                        <!-- View Mode -->
                                        <div class="field-value-container field-value-container-column">
                                            <div class="field-value field-value-multiline">@if (login.Note != null && login.Note.Any()){@string.Join(Environment.NewLine, login.Note)}else{<span class="text-muted">No notes</span>}</div> <!-- The condition must be written in one row for correct display on the page -->
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEditTextarea(this)" title="Edit notes">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <!-- Edit Mode -->
                                        <div class="edit-mode-container edit-mode-textarea" style="display: none;">
                                            <div class="field-value-container field-value-container-column">
                                                <textarea class="form-input edit-input edit-input-textarea" rows="5">@(login.Note != null && login.Note.Any() ? string.Join(Environment.NewLine, login.Note) : "")</textarea>
                                                <div class="edit-actions-textarea">
                                                    <button type="button" class="field-action-btn save-btn" onclick="saveEditTextarea(this)" title="Save">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M20 6 9 17l-5-5"></path>
                                                        </svg>
                                                    </button>
                                                    <button type="button" class="field-action-btn cancel-btn" onclick="cancelEditTextarea(this)" title="Cancel">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M18 6 6 18" />
                                                            <path d="m6 6 12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                break;

                            case CardItemViewModel card:

                                <!-- Folder -->
                                <div class="field-group">
                                    <label class="field-label">Folder</label>
                                    <div class="editable-field" data-field="FolderId" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container">
                                            <span class="field-value">@(card.FolderName ?? "No Folder")</span>
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit folder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="edit-mode-container" style="display:none">
                                            <select class="form-input edit-input" value="@card.FolderId">
                                                <option value="">No Folder</option>
                                                @foreach (var folder in folders)
                                                {
                                                    <option value="@folder.Key">@folder.Value</option>
                                                }
                                            </select>
                                            <div class="edit-actions">
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card Number -->
                                <div class="field-group">
                                    <label class="field-label">Card Number</label>
                                    <div class="editable-field" data-field="CardNumber" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container">
                                            @if (string.IsNullOrEmpty(card.CardNumber))
                                            {
                                                <span class="field-value"><span class="text-muted">Not set</span></span>
                                            }
                                            else
                                            {
                                                <span class="field-value">@card.CardNumber</span>
                                            }
                                        </div>
                                        <div class="field-actions">
                                        <button type="button" class="field-action-btn copy-btn" onclick="copyToClipboard('@card.CardNumber', 'Card Number')" title="Copy card number">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                            </svg>
                                        </button>
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit card number">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="edit-mode-container" style="display: none;">
                                            <input type="text" class="form-input edit-input" value="@(card.CardNumber ?? "")" maxlength="19" oninput="formatCardNumber(this)" />
                                            <div class="edit-actions">
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Expiration Date -->
                                <div class="field-group-inline">
                                    <div class="field-group">
                                        <label class="field-label">Exp. Month</label>
                                        <div class="editable-field" data-field="ExpireMonth" data-id="@card.Id" data-type="Card">
                                            <div class="field-value-container">
                                                @if (string.IsNullOrEmpty(card.ExpireMonth))
                                                {
                                                    <span class="field-value">Month</span>
                                                }
                                                else
                                                {
                                                    <span class="field-value">@card.ExpireMonth</span>
                                                }
                                            </div>
                                            <div class="field-actions">
                                                <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit month">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                        <path d="m15 5 4 4" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="edit-mode-container" style="display:none">
                                                <select class="form-input edit-input" value="@card.ExpireMonth">
                                                    <option value="">Month</option>
                                                    @for (int i = 1; i <= 12; i++)
                                                    {
                                                        <option value="@i.ToString("D2")">@i.ToString("D2")</option>
                                                    }
                                                </select>
                                                <div class="edit-actions">
                                                    <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M20 6 9 17l-5-5"></path>
                                                        </svg>
                                                    </button>
                                                    <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M18 6 6 18" />
                                                            <path d="m6 6 12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">Exp. Year</label>
                                        <div class="editable-field" data-field="ExpireYear" data-id="@card.Id" data-type="Card">
                                            <div class="field-value-container">
                                                @if (string.IsNullOrEmpty(card.ExpireYear))
                                                {
                                                    <span class="field-value">Year</span>
                                                }
                                                else
                                                {
                                                    <span class="field-value">@card.ExpireYear</span>
                                                }
                                            </div>
                                            <div class="field-actions">
                                                <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit year">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                        <path d="m15 5 4 4" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <div class="edit-mode-container" style="display:none">
                                                <select class="form-input edit-input" value="@card.ExpireYear">
                                                    <option value="">Year</option>
                                                    @for (int i = DateTime.Now.Year; i <= DateTime.Now.Year + 15; i++)
                                                    {
                                                        <option value="@i.ToString().Substring(2)">@i</option>
                                                    }
                                                </select>
                                                <div class="edit-actions">
                                                    <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M20 6 9 17l-5-5"></path>
                                                        </svg>
                                                    </button>
                                                    <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M18 6 6 18" />
                                                            <path d="m6 6 12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- CardholderName -->
                                <div class="field-group">
                                    <label class="field-label">Cardholder Name</label>
                                    <div class="editable-field" data-field="CardholderName" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container">
                                            @if (string.IsNullOrEmpty(card.CardholderName))
                                            {
                                                <span class="field-value"><span class="text-muted">Not set</span></span>
                                            }
                                            else
                                            {
                                                <span class="field-value">@card.CardholderName</span>
                                            }
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn copy-btn" onclick="copyToClipboard('@card.CardholderName', 'Cardholder Name')" title="Copy cardholder name">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                </svg>
                                            </button>
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit cardholder name">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="edit-mode-container" style="display: none;">
                                            <input type="text" class="form-input edit-input" value="@(card.CardholderName ?? "")" maxlength="50" />
                                            <div class="edit-actions">
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="field-group">
                                    <label class="field-label">Notes</label>
                                    <div class="editable-field editable-field-textarea" data-field="Note" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container field-value-container-column">
                                            <div class="field-value field-value-multiline">@if (card.Note != null && card.Note.Any()){@string.Join(Environment.NewLine, card.Note)}else{<span class="text-muted">No notes</span>}</div> <!-- The condition must be written in one row for correct display on the page -->
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEditTextarea(this)" title="Edit notes">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="edit-mode-container edit-mode-textarea" style="display: none;">
                                            <div class="field-value-container field-value-container-column">
                                                <textarea class="form-input edit-input edit-input-textarea" rows="5">@(card.Note != null && card.Note.Any() ? string.Join(Environment.NewLine, card.Note) : "")</textarea>
                                                <div class="edit-actions-textarea">
                                                    <button type="button" class="field-action-btn save-btn" onclick="saveEditTextarea(this)" title="Save">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M20 6 9 17l-5-5"></path>
                                                        </svg>
                                                    </button>
                                                    <button type="button" class="field-action-btn cancel-btn" onclick="cancelEditTextarea(this)" title="Cancel">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M18 6 6 18" />
                                                            <path d="m6 6 12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                break;

                            case NoteItemViewModel note:

                                <!-- Folder -->
                                <div class="field-group">
                                    <label class="field-label">Folder</label>
                                    <div class="editable-field" data-field="FolderId" data-id="@note.Id" data-type="Note">
                                        <div class="field-value-container">
                                            <span class="field-value">@(note.FolderName ?? "No Folder")</span>
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEdit(this)" title="Edit folder">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="edit-mode-container" style="display:none">
                                            <select class="form-input edit-input" value="@note.FolderId">
                                                <option value="">No Folder</option>
                                                @foreach (var folder in folders)
                                                {
                                                    <option value="@folder.Key">@folder.Value</option>
                                                }
                                            </select>
                                            <div class="edit-actions">
                                                <button type="button" class="field-action-btn save-btn" onclick="saveEdit(this)" title="Save">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                </button>
                                                <button type="button" class="field-action-btn cancel-btn" onclick="cancelEdit(this)" title="Cancel">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M18 6 6 18" />
                                                        <path d="m6 6 12 12" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Note Content -->
                                <div class="field-group">
                                    <label class="field-label">Content</label>
                                    <div class="editable-field editable-field-textarea" data-field="Content" data-id="@note.Id" data-type="Note">
                                        <div class="field-value-container field-value-container-column">
                                            <div class="field-value field-value-multiline">@if (note.Content != null && note.Content.Any()){@string.Join(Environment.NewLine, note.Content)}else{<span class="text-muted">No content</span>}</div> <!-- The condition must be written in one row for correct display on the page -->
                                        </div>
                                        <div class="field-actions">
                                            <button type="button" class="field-action-btn edit-btn" onclick="enableEditTextarea(this)" title="Edit content">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="edit-mode-container edit-mode-textarea" style="display: none;">
                                            <div class="field-value-container field-value-container-column">
                                                <textarea class="form-input edit-input edit-input-textarea" rows="10">@(note.Content != null && note.Content.Any() ? string.Join(Environment.NewLine, note.Content) : "")</textarea>
                                                <div class="edit-actions-textarea">
                                                    <button type="button" class="field-action-btn save-btn" onclick="saveEditTextarea(this)" title="Save">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M20 6 9 17l-5-5"></path>
                                                        </svg>
                                                    </button>
                                                    <button type="button" class="field-action-btn cancel-btn" onclick="cancelEditTextarea(this)" title="Cancel">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M18 6 6 18" />
                                                            <path d="m6 6 12 12" />
                                                        </svg>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                break;
                        }

                        <!-- Metadata (read-only) -->
                        <div class="field-group metadata">
                            <label class="field-label">Created</label>
                            <div class="field-value">@Model.Item.CreatedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Edit Title Modal -->
<div id="editTitleModal" class="title-modal">
    <div class="title-modal-overlay" onclick="closeEditTitleModal()"></div>
    <div class="title-modal-content">
        <div class="title-modal-header">
            <h3 class="title-modal-heading">Edit Title</h3>
            <button class="title-modal-close" onclick="closeEditTitleModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
        <div class="title-modal-body">
            <div class="form-group">
                <label for="modalTitleInput">Title</label>
                <input type="text" id="modalTitleInput" class="form-input" placeholder="Enter title">
            </div>
        </div>
        <div class="title-modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEditTitleModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveModalTitle()">Save</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        /* ========================================
           TITLE MODAL FUNCTIONS
           ======================================== */

        function openEditTitleModal() {
            const modal = document.getElementById('editTitleModal');
            const titleElement = document.querySelector('.item-title');
            const modalInput = document.getElementById('modalTitleInput');
            modalInput.value = titleElement.textContent.trim();
            modal.style.display = 'flex';
            setTimeout(() => modalInput.focus(), 100);
        }

        function closeEditTitleModal() {
            const modal = document.getElementById('editTitleModal');
            modal.style.display = 'none';
        }

        async function saveModalTitle() {
            const modalInput = document.getElementById('modalTitleInput');
            const newTitle = modalInput.value.trim();

            if (!newTitle) {
                showNotification('Title cannot be empty', 'error');
                return;
            }

            const editableField = document.querySelector('.title-edit-wrapper');
            const itemId = editableField.dataset.id;
            const itemType = editableField.dataset.type;
            const saveBtn = event.target;
            saveBtn.disabled = true;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('/Vault/UpdateField', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams({
                        id: itemId,
                        itemType: itemType,
                        fieldName: 'Title',
                        fieldValue: newTitle,
                        __RequestVerificationToken: token
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const titleElement = document.querySelector('.item-title');
                    titleElement.textContent = newTitle;
                    closeEditTitleModal();
                    showNotification('Title updated successfully', 'success');
                } else {
                    showNotification(result.message || 'Failed to update title', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while updating', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditTitleModal();
            }
        });

        document.getElementById('modalTitleInput')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveModalTitle();
            }
        });

        /* ========================================
           PASSWORD VISIBILITY TOGGLE
           ======================================== */

        function togglePasswordVisibility(btn, isViewMode) {
            const editableField = btn.closest('.editable-field');
            let input, eyeClosed, eyeOpen;

            if (isViewMode) {
                const container = editableField.querySelector('.field-value-container');
                input = container.querySelector('input');
                eyeClosed = btn.querySelector('.eye-closed');
                eyeOpen = btn.querySelector('.eye-open');
            } else {
                const container = btn.closest('.password-input-group');
                input = container.querySelector('input');
                eyeClosed = btn.querySelector('.eye-closed');
                eyeOpen = btn.querySelector('.eye-open');
            }

            if (input.type === 'password') {
                input.type = 'text';
                eyeClosed.style.display = 'none';
                eyeOpen.style.display = 'block';
            } else {
                input.type = 'password';
                eyeClosed.style.display = 'block';
                eyeOpen.style.display = 'none';
            }
        }

        /* ========================================
           PASSWORD GENERATOR
           ======================================== */

        function openPasswordGenerator(btn) {
            const passwordField = btn.closest('.editable-field-password');
            const passwordInput = passwordField.querySelector('.edit-password-input');

            if (typeof openGenerator === 'function') {
                const event = {
                    preventDefault: () => {},
                    target: passwordInput,
                    currentTarget: passwordInput
                };
                openGenerator(event);
            } else {
                showNotification('Password generator not available', 'error');
            }
        }

        /* ========================================
           FIELD EDIT FUNCTIONS
           ======================================== */

        function enableEdit(btn) {
            const editableField = btn.closest('.editable-field');
            const viewContainer = editableField.querySelector('.field-value-container');
            const editContainer = editableField.querySelector('.edit-mode-container');
            const fieldActions = editableField.querySelector('.field-actions');

            if (!editContainer) return;

            const editInput = editContainer.querySelector('.edit-input');
            if (editInput) {
                if (editInput.tagName === 'SELECT') {
                    const currentValue = editableField.querySelector('.field-value')?.textContent.trim();
                    const options = editInput.querySelectorAll('option');
                    for (let option of options) {
                        if (option.text === currentValue || option.value === currentValue) {
                            editInput.value = option.value;
                            break;
                        }
                    }
                }
                editInput.setAttribute('data-original-value', editInput.value);
            }

            if (viewContainer) viewContainer.style.display = 'none';
            if (fieldActions) fieldActions.style.display = 'none';
            editContainer.style.display = 'flex';

            const inputElement = editInput || editContainer.querySelector('input, textarea, select');
            if (inputElement && inputElement.focus) {
                setTimeout(() => {
                    inputElement.focus();
                    if (inputElement.select) inputElement.select();
                }, 10);
            }
        }

        function enableEditTextarea(btn) {
            const editableField = btn.closest('.editable-field');
            const viewContainer = editableField.querySelector('.field-value-container');
            const editContainer = editableField.querySelector('.edit-mode-container');
            const fieldActions = editableField.querySelector('.field-actions');

            if (!editContainer) return;

            const editInput = editContainer.querySelector('.edit-input-textarea');
            if (editInput) {
                editInput.setAttribute('data-original-value', editInput.value);
            }

            if (viewContainer) viewContainer.style.display = 'none';
            if (fieldActions) fieldActions.style.display = 'none';
            editContainer.style.display = 'block';

            if (editInput) {
                setTimeout(() => {
                    editInput.focus();
                    editInput.style.height = 'auto';
                    editInput.style.height = editInput.scrollHeight + 'px';
                }, 10);
            }
        }

        function cancelEditTextarea(btn) {
            const editableField = btn.closest('.editable-field');
            const viewContainer = editableField.querySelector('.field-value-container');
            const editContainer = editableField.querySelector('.edit-mode-container');
            const fieldActions = editableField.querySelector('.field-actions');
            const editInput = editContainer.querySelector('.edit-input-textarea');

            const originalValue = editInput?.getAttribute('data-original-value');
            if (originalValue !== null && editInput) {
                editInput.value = originalValue;
            }

            if (viewContainer) viewContainer.style.display = 'flex';
            if (fieldActions) fieldActions.style.display = 'flex';
            if (editContainer) editContainer.style.display = 'none';
        }

        async function saveEditTextarea(btn) {
            const editableField = btn.closest('.editable-field');
            const viewContainer = editableField.querySelector('.field-value-container');
            const editContainer = editableField.querySelector('.edit-mode-container');
            const fieldActions = editableField.querySelector('.field-actions');
            const editInput = editContainer.querySelector('.edit-input-textarea');

            const fieldName = editableField.dataset.field;
            const itemId = editableField.dataset.id;
            const itemType = editableField.dataset.type;

            // Trim the value and check if empty
            let newValue = editInput.value.trim();
            const isEmpty = newValue === '';

            let displayValue = newValue || 'No notes';
            if (fieldName === 'Content') {
                displayValue = newValue || 'No content';
            }

            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const formData = new URLSearchParams({
                    id: itemId,
                    itemType: itemType,
                    fieldName: fieldName,
                    __RequestVerificationToken: token
                });

                // Add fieldValue only if not empty, otherwise add isEmpty flag
                if (!isEmpty) {
                    formData.append('fieldValue', newValue);
                } else {
                    formData.append('fieldValue', '');
                    formData.append('isEmpty', 'true');
                }

                const response = await fetch('/Vault/UpdateField', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const fieldValueElement = viewContainer.querySelector('.field-value-multiline');
                    if (fieldValueElement) {
                        if (newValue) {
                            fieldValueElement.innerHTML = '';
                            fieldValueElement.textContent = newValue;
                        } else {
                            fieldValueElement.innerHTML = `<span class="text-muted">${displayValue}</span>`;
                        }
                    }

                    if (viewContainer) viewContainer.style.display = 'flex';
                    if (fieldActions) fieldActions.style.display = 'flex';
                    if (editContainer) editContainer.style.display = 'none';

                    showNotification('Field updated successfully', 'success');
                } else {
                    showNotification(result.message || 'Failed to update field', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while updating', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        function cancelEdit(btn) {
            const editableField = btn.closest('.editable-field');
            const viewContainer = editableField.querySelector('.field-value-container');
            const editContainer = editableField.querySelector('.edit-mode-container');
            const fieldActions = editableField.querySelector('.field-actions');
            const editInput = editContainer.querySelector('.edit-input');

            const originalValue = editInput?.getAttribute('data-original-value');
            if (originalValue !== null && editInput) {
                editInput.value = originalValue;
            }

            const isPasswordField = editableField.classList.contains('editable-field-password');
            if (isPasswordField && editInput) {
                editInput.type = 'password';
                const toggleBtn = editContainer.querySelector('.toggle-btn');
                if (toggleBtn) {
                    toggleBtn.querySelector('.eye-closed').style.display = 'block';
                    toggleBtn.querySelector('.eye-open').style.display = 'none';
                }
            }

            if (viewContainer) viewContainer.style.display = 'flex';
            if (fieldActions) fieldActions.style.display = 'flex';
            if (editContainer) editContainer.style.display = 'none';
        }

        async function saveEdit(btn) {
            const editableField = btn.closest('.editable-field');
            const viewContainer = editableField.querySelector('.field-value-container');
            const editContainer = editableField.querySelector('.edit-mode-container');
            const fieldActions = editableField.querySelector('.field-actions');
            const editInput = editContainer.querySelector('.edit-input');

            const fieldName = editableField.dataset.field;
            const itemId = editableField.dataset.id;
            const itemType = editableField.dataset.type;

            // Get value and trim it (except for SELECT)
            let newValue = editInput.value;
            if (editInput.tagName !== 'SELECT') {
                newValue = newValue.trim();
            }

            const isEmpty = newValue === '';
            let displayValue = newValue;

            if (editInput.tagName === 'SELECT') {
                const selectedOption = editInput.options[editInput.selectedIndex];
                displayValue = selectedOption ? selectedOption.text : 'No Folder';
            } else if (editInput.tagName === 'TEXTAREA') {
                displayValue = newValue || 'No notes';
            } else if (isEmpty) {
                displayValue = 'Not set';
            }

            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const formData = new URLSearchParams({
                    id: itemId,
                    itemType: itemType,
                    fieldName: fieldName,
                    __RequestVerificationToken: token
                });

                // Add fieldValue only if not empty, otherwise add isEmpty flag
                if (!isEmpty) {
                    formData.append('fieldValue', newValue);
                } else {
                    formData.append('fieldValue', '');
                    formData.append('isEmpty', 'true');
                }

                const response = await fetch('/Vault/UpdateField', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const isPasswordField = editableField.classList.contains('editable-field-password');

                    if (isPasswordField) {
                        // Update password field view
                        if (isEmpty) {
                            viewContainer.innerHTML = '<span class="field-value"><span class="text-muted">Not set</span></span>';
                        } else {
                            viewContainer.innerHTML = '<input type="password" class="password-display-input" value="' + newValue + '" readonly tabindex="-1">';
                        }

                        // Update field actions visibility
                        const copyBtn = fieldActions.querySelector('.copy-btn');
                        const toggleBtn = fieldActions.querySelector('.toggle-btn');

                        if (isEmpty) {
                            if (copyBtn) copyBtn.style.display = 'none';
                            if (toggleBtn) toggleBtn.style.display = 'none';
                        } else {
                            if (copyBtn) copyBtn.style.display = '';
                            if (toggleBtn) {
                                toggleBtn.style.display = '';
                                toggleBtn.querySelector('.eye-closed').style.display = 'block';
                                toggleBtn.querySelector('.eye-open').style.display = 'none';
                            }
                        }

                        // Reset edit mode password visibility
                        editInput.type = 'password';
                        const editToggleBtn = editContainer.querySelector('.toggle-btn');
                        if (editToggleBtn) {
                            editToggleBtn.querySelector('.eye-closed').style.display = 'block';
                            editToggleBtn.querySelector('.eye-open').style.display = 'none';
                        }
                    } else {
                        // Update regular fields (including WebURL, CardNumber, CardholderName, etc.)
                        const fieldValue = viewContainer.querySelector('.field-value');
                        if (fieldValue) {
                            if (isEmpty && editInput.tagName !== 'SELECT') {
                                fieldValue.innerHTML = '<span class="text-muted">Not set</span>';
                            } else if (fieldName === 'WebURL' && !isEmpty) {
                                // Reconstruct URL link
                                const url = displayValue.startsWith('http://') || displayValue.startsWith('https://')
                                    ? displayValue
                                    : 'https://' + displayValue;
                                fieldValue.outerHTML = `<a href="${url}" target="_blank" class="field-value link" rel="noopener noreferrer">${displayValue}</a>`;
                            } else {
                                fieldValue.textContent = displayValue;
                            }
                        }

                        // Update copy button visibility for fields with copy buttons
                        const fieldsWithCopy = ['WebURL', 'CardNumber', 'CardholderName', 'Login'];
                        if (fieldsWithCopy.includes(fieldName)) {
                            const copyBtn = fieldActions.querySelector('.copy-btn');
                            if (copyBtn) {
                                copyBtn.style.display = '';
                            }
                        }
                    }

                    if (viewContainer) viewContainer.style.display = 'flex';
                    if (fieldActions) fieldActions.style.display = 'flex';
                    if (editContainer) editContainer.style.display = 'none';

                    showNotification('Field updated successfully', 'success');
                } else {
                    showNotification(result.message || 'Failed to update field', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while updating', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        /* ========================================
           UTILITY FUNCTIONS
           ======================================== */

        function formatCardNumber(input) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            input.value = formattedValue;
        }

        function copyToClipboard(text, label) {
            if (!text) return;

            navigator.clipboard.writeText(text).then(() => {
                showNotification(`${label} copied to clipboard!`, 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showNotification('Failed to copy', 'error');
            });
        }

        function confirmDelete() {
            return confirm('Are you sure you want to delete this item? This action cannot be undone.');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 9999;
                animation: slideIn 0.3s ease;
                font-size: 14px;
                font-weight: 500;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        /* ========================================
           AUTO-RESIZE TEXTAREAS
           ======================================== */

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.edit-input-textarea').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
            });
        });
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/view-item.css" asp-append-version="true" />
}
