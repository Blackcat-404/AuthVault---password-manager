@using PasswordManager.ViewModels.Vault
@using PasswordManager.ViewModels.Vault.VaultItems
@model ViewItemViewModel

@{
    ViewData["Title"] = "View Item";
    Layout = "_VaultLayout";

    var itemType = Model.Item switch
    {
        LoginItemViewModel => "Login",
        CardItemViewModel => "Card",
        NoteItemViewModel => "Note",
        _ => "Unknown"
    };

    var folders = Model.Folders;
}

<div class="vault-page">
    <div class="app-container">
        <main class="main-content">
            @Html.AntiForgeryToken()

            <!-- Header with back button -->
            <header class="header">
                <div class="header-left">
                    <a href="@Url.Action("Home", "Vault")" class="btn btn-ghost">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="20"
                             height="20"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2">
                            <path d="m15 18-6-6 6-6" />
                        </svg>
                        Back to Vault
                    </a>
                </div>

                <div class="header-actions">
                    <form asp-action="DeleteItem" asp-controller="Vault" method="post" onsubmit="return confirmDelete()">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.Item.Id" />
                        <input type="hidden" name="type" value="@itemType" />
                        <button type="submit" class="btn btn-danger">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 width="20"
                                 height="20"
                                 viewBox="0 0 24 24"
                                 fill="none"
                                 stroke="currentColor"
                                 stroke-width="2">
                                <path d="M3 6h18" />
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                            </svg>
                            Delete Item
                        </button>
                    </form>
                </div>
            </header>

            <!-- Item details -->
            <div class="content-area">
                <div class="item-view-container">

                    <!-- Item icon and title -->
                    <div class="item-view-header">
                        @switch (Model.Item)
                        {
                            case LoginItemViewModel:
                                <div class="item-view-icon login">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         width="32"
                                         height="32"
                                         viewBox="0 0 24 24"
                                         fill="none"
                                         stroke="currentColor"
                                         stroke-width="2">
                                        <rect width="18" height="11" x="3" y="11" rx="2" ry="2" />
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                                    </svg>
                                </div>
                                break;
                            case CardItemViewModel:
                                <div class="item-view-icon card">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         width="32"
                                         height="32"
                                         viewBox="0 0 24 24"
                                         fill="none"
                                         stroke="currentColor"
                                         stroke-width="2">
                                        <rect width="20" height="14" x="2" y="5" rx="2" />
                                        <line x1="2" x2="22" y1="10" y2="10" />
                                    </svg>
                                </div>
                                break;
                            case NoteItemViewModel:
                                <div class="item-view-icon note">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                         width="32"
                                         height="32"
                                         viewBox="0 0 24 24"
                                         fill="none"
                                         stroke="currentColor"
                                         stroke-width="2">
                                        <path d="M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z" />
                                        <path d="M14 2v5a1 1 0 0 0 1 1h5" />
                                    </svg>
                                </div>
                                break;
                        }

                        <div class="item-view-title-section">
                            <div class="title-with-badge">
                                <div class="editable-field editable-field-title" data-field="Title" data-id="@Model.Item.Id" data-type="@itemType">
                                    <h1 class="item-view-title">@Model.Item.Title</h1>
                                    <button class="edit-btn edit-btn-title" onclick="openEditTitleModal()" title="Edit title">
                                        <svg xmlns="http://www.w3.org/2000/svg"
                                             width="20"
                                             height="20"
                                             viewBox="0 0 24 24"
                                             fill="none"
                                             stroke="currentColor"
                                             stroke-width="2">
                                            <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                            <path d="m15 5 4 4" />
                                        </svg>
                                    </button>
                                </div>
                                <span class="item-type-badge">@itemType</span>
                            </div>
                        </div>
                    </div>

                    <!-- Fields based on item type -->
                    <div class="item-view-fields">

                        @switch (Model.Item)
                        {
                            case LoginItemViewModel login:

                                <!-- Folder -->
                                <div class="field-group">
                                    <label class="field-label">Folder</label>
                                    <div class="editable-field" data-field="FolderId" data-id="@login.Id" data-type="Login">
                                        <div class="field-value-container">
                                            <span class="field-value">@(login.FolderName ?? "No Folder")</span>
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <select class="edit-input edit-select" style="display:none" value="@login.FolderId">
                                            <option value="">No Folder</option>
                                            @foreach (var folder in folders)
                                            {
                                                <option value="@folder.Key">@folder.Value</option>
                                            }
                                        </select>
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Username/Email -->
                                <div class="field-group">
                                    <label class="field-label">Username / Email</label>
                                    <div class="editable-field" data-field="Login" data-id="@login.Id" data-type="Login">
                                        <div class="field-value-container">
                                            <span class="field-value">@(string.IsNullOrEmpty(login.Login) ? "Not set" : @login.Login)</span>
                                            @if (!string.IsNullOrEmpty(login.Login))
                                            {
                                                <button class="copy-btn" onclick="copyToClipboard('@login.Login', 'Username')">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="16"
                                                         height="16"
                                                         viewBox="0 0 24 24"
                                                         fill="none"
                                                         stroke="currentColor"
                                                         stroke-width="2">
                                                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                    </svg>
                                                </button>
                                            }
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <input type="text" class="edit-input" value="@login.Login" style="display: none;" />
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Password -->
                                <div class="field-group">
                                    <label class="field-label">Password</label>
                                    <div class="editable-field" data-field="Password" data-id="@login.Id" data-type="Login">
                                        <div class="field-value-container">
                                            <span class="field-value password-hidden">••••••••••••</span>
                                            <button class="toggle-password-btn" onclick="togglePasswordVisibility(this)" data-password="@login.Password">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     class="eye-open"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                                    <circle cx="12" cy="12" r="3" />
                                                </svg>
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     class="eye-closed"
                                                     style="display: none;"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M9.88 9.88a3 3 0 1 0 4.24 4.24" />
                                                    <path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68" />
                                                    <path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61" />
                                                    <line x1="2" x2="22" y1="2" y2="22" />
                                                </svg>
                                            </button>
                                            @if (!string.IsNullOrEmpty(login.Password))
                                            {
                                                <button class="copy-btn" onclick="copyToClipboard('@login.Password', 'Password')">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="16"
                                                         height="16"
                                                         viewBox="0 0 24 24"
                                                         fill="none"
                                                         stroke="currentColor"
                                                         stroke-width="2">
                                                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                    </svg>
                                                </button>
                                            }
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <input type="password" class="edit-input" value="@login.Password" style="display: none;" data-actual-value="@login.Password" />
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- URL -->
                                @if (login.WebURL == null) login.WebURL = "";
                                <div class="field-group">
                                    <label class="field-label">Website URL</label>
                                    <div class="editable-field" data-field="WebURL" data-id="@login.Id" data-type="Login">
                                        <div class="field-value-container">
                                            <a href="@(login.WebURL.StartsWith("http://") || login.WebURL.StartsWith("https://") ? login.WebURL : "https://" + login.WebURL)"
                                               target="_blank"
                                               class="field-value link"
                                               rel="noopener noreferrer">@login.WebURL</a>
                                            <button class="copy-btn" onclick="copyToClipboard('@login.WebURL', 'URL')">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                </svg>
                                            </button>
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <input type="url" class="edit-input" value="@login.WebURL" style="display: none;" />
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="field-group">
                                    <label class="field-label">Notes</label>
                                    <div class="editable-field editable-field-textarea" data-field="Note" data-id="@login.Id" data-type="Login">
                                        <div class="field-value-container field-value-container-column">
                                            <div class="field-value field-value-multiline">
                                                @if (login.Note != null && login.Note.Any())
                                                {
                                                    @string.Join(Environment.NewLine, login.Note)
                                                }
                                                else
                                                {
                                                    <span class="text-muted">No notes</span>
                                                }
                                            </div>
                                            <button class="edit-btn edit-btn-textarea" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <textarea class="edit-input edit-input-textarea" style="display: none;" rows="5">@(login.Note != null && login.Note.Any() ? string.Join(Environment.NewLine, login.Note) : "")</textarea>
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>
                                break;

                            case CardItemViewModel card:

                                <!-- Folder -->
                                <div class="field-group">
                                    <label class="field-label">Folder</label>
                                    <div class="editable-field" data-field="FolderId" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container">
                                            <span class="field-value">@(card.FolderName ?? "No Folder")</span>
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <select class="edit-input edit-select" style="display:none" value="@card.FolderId">
                                            <option value="">No Folder</option>
                                            @foreach (var folder in folders)
                                            {
                                                <option value="@folder.Key">@folder.Value</option>
                                            }
                                        </select>
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Card Number -->
                                <div class="field-group">
                                    <label class="field-label">Card Number</label>
                                    <div class="editable-field" id="card-number" data-field="CardNumber" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container">
                                            <span class="field-value">@card.CardNumber</span>
                                            @if (!string.IsNullOrEmpty(card.CardNumber))
                                            {
                                                <button class="copy-btn" onclick="copyToClipboard('@card.CardNumber', 'Card number')">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="16"
                                                         height="16"
                                                         viewBox="0 0 24 24"
                                                         fill="none"
                                                         stroke="currentColor"
                                                         stroke-width="2">
                                                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                    </svg>
                                                </button>
                                            }
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <input type="text" class="edit-input" value="@card.CardNumber" style="display: none;" maxlength="19" oninput="formatCardNumber(this)" />
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Expiration Date -->
                                <div class="field-group-inline">
                                    <div class="field-group">
                                        <label class="field-label">Exp. Month</label>
                                        <div class="editable-field" data-field="ExpireMonth" data-id="@card.Id" data-type="Card">
                                            <div class="field-value-container">
                                                <span class="field-value">@card.ExpireMonth</span>
                                                <button class="edit-btn" onclick="enableEdit(this)">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="16"
                                                         height="16"
                                                         viewBox="0 0 24 24"
                                                         fill="none"
                                                         stroke="currentColor"
                                                         stroke-width="2">
                                                        <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                        <path d="m15 5 4 4" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <select class="edit-input edit-select" style="display:none" value="@card.ExpireMonth">
                                                <option value="">Month</option>
                                                @for (int i = 1; i <= 12; i++)
                                                {
                                                    <option value="@i.ToString("D2")">@i.ToString("D2")</option>
                                                }
                                            </select>
                                            <div class="edit-actions" style="display: none;">
                                                <button class="btn-save" onclick="saveEdit(this)">✓</button>
                                                <button class="btn-cancel" onclick="cancelEdit(this)">✕</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="field-group">
                                        <label class="field-label">Exp. Year</label>
                                        <div class="editable-field" data-field="ExpireYear" data-id="@card.Id" data-type="Card">
                                            <div class="field-value-container">
                                                <span class="field-value">@card.ExpireYear</span>
                                                <button class="edit-btn" onclick="enableEdit(this)">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="16"
                                                         height="16"
                                                         viewBox="0 0 24 24"
                                                         fill="none"
                                                         stroke="currentColor"
                                                         stroke-width="2">
                                                        <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                        <path d="m15 5 4 4" />
                                                    </svg>
                                                </button>
                                            </div>
                                            <select class="edit-input edit-select" style="display:none" value="@card.ExpireYear">
                                                <option value="">Year</option>
                                                @for (int i = DateTime.Now.Year; i <= DateTime.Now.Year + 15; i++)
                                                {
                                                    <option value="@i.ToString().Substring(2)">@i</option>
                                                }
                                            </select>

                                            <div class="edit-actions" style="display: none;">
                                                <button class="btn-save" onclick="saveEdit(this)">✓</button>
                                                <button class="btn-cancel" onclick="cancelEdit(this)">✕</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- CardholderName -->
                                @if (card.CardholderName == null) card.CardholderName = "";
                                <div class="field-group">
                                    <label class="field-label">Cardholder Name</label>
                                    <div class="editable-field" id="cardholder-name" data-field="CardholderName" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container">
                                            <span class="field-value">@card.CardholderName</span>
                                            @if (!string.IsNullOrEmpty(card.CardholderName))
                                            {
                                                <button class="copy-btn" onclick="copyToClipboard('@card.CardholderName', 'Cardholder Name')">
                                                    <svg xmlns="http://www.w3.org/2000/svg"
                                                         width="16"
                                                         height="16"
                                                         viewBox="0 0 24 24"
                                                         fill="none"
                                                         stroke="currentColor"
                                                         stroke-width="2">
                                                        <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                                        <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                                    </svg>
                                                </button>
                                            }
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <input type="text" class="edit-input" value="@card.CardholderName" style="display: none;" maxlength="19" oninput="formatCardholderName(this)" />
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Notes -->
                                <div class="field-group">
                                    <label class="field-label">Notes</label>
                                    <div class="editable-field editable-field-textarea" data-field="Note" data-id="@card.Id" data-type="Card">
                                        <div class="field-value-container field-value-container-column">
                                            <div class="field-value field-value-multiline">
                                                @if (card.Note != null && card.Note.Any())
                                                {
                                                    @string.Join(Environment.NewLine, card.Note)
                                                }
                                                else
                                                {
                                                    <span class="text-muted">No notes</span>
                                                }
                                            </div>
                                            <button class="edit-btn edit-btn-textarea" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <textarea class="edit-input edit-input-textarea" style="display: none;" rows="5">@(card.Note != null && card.Note.Any() ? string.Join(Environment.NewLine, card.Note) : "")</textarea>
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>
                                break;

                            case NoteItemViewModel note:

                                <!-- Folder -->
                                <div class="field-group">
                                    <label class="field-label">Folder</label>
                                    <div class="editable-field" data-field="FolderId" data-id="@note.Id" data-type="Note">
                                        <div class="field-value-container">
                                            <span class="field-value">@(note.FolderName ?? "No Folder")</span>
                                            <button class="edit-btn" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <select class="edit-input edit-select" style="display:none" value="@note.FolderId">
                                            <option value="">No Folder</option>
                                            @foreach (var folder in folders)
                                            {
                                                <option value="@folder.Key">@folder.Value</option>
                                            }
                                        </select>
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Note Content -->
                                <div class="field-group">
                                    <label class="field-label">Content</label>
                                    <div class="editable-field editable-field-textarea" data-field="Content" data-id="@note.Id" data-type="Note">
                                        <div class="field-value-container field-value-container-column">
                                            <div class="field-value field-value-multiline">
                                                @if (note.Content != null && note.Content.Any())
                                                {
                                                    @string.Join(Environment.NewLine, note.Content)
                                                }
                                                else
                                                {
                                                    <span class="text-muted">No content</span>
                                                }
                                            </div>
                                            <button class="edit-btn edit-btn-textarea" onclick="enableEdit(this)">
                                                <svg xmlns="http://www.w3.org/2000/svg"
                                                     width="16"
                                                     height="16"
                                                     viewBox="0 0 24 24"
                                                     fill="none"
                                                     stroke="currentColor"
                                                     stroke-width="2">
                                                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z" />
                                                    <path d="m15 5 4 4" />
                                                </svg>
                                            </button>
                                        </div>
                                        <textarea class="edit-input edit-input-textarea" style="display: none;" rows="10">@(note.Content != null && note.Content.Any() ? string.Join(Environment.NewLine, note.Content) : "")</textarea>
                                        <div class="edit-actions" style="display: none;">
                                            <button class="btn-save" onclick="saveEdit(this)">✓ Save</button>
                                            <button class="btn-cancel" onclick="cancelEdit(this)">✕ Cancel</button>
                                        </div>
                                    </div>
                                </div>
                                break;
                        }

                        <!-- Metadata (read-only) -->
                        <div class="field-group metadata">
                            <label class="field-label">Created</label>
                            <div class="field-value">@Model.Item.CreatedAt.ToString("MMMM dd, yyyy 'at' HH:mm")</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Edit Title Modal -->
<div id="editTitleModal" class="modal">
    <div class="modal-overlay" onclick="closeEditTitleModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Edit Title</h3>
            <button class="modal-close" onclick="closeEditTitleModal()">
                <svg xmlns="http://www.w3.org/2000/svg"
                     width="24"
                     height="24"
                     viewBox="0 0 24 24"
                     fill="none"
                     stroke="currentColor"
                     stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18" />
                    <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="modalTitleInput">Title</label>
                <input type="text" id="modalTitleInput" class="form-input" placeholder="Enter title">
            </div>
        </div>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEditTitleModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveModalTitle()">Save</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Modal functions
        function openEditTitleModal() {
            const modal = document.getElementById('editTitleModal');
            const titleElement = document.querySelector('.item-view-title');
            const modalInput = document.getElementById('modalTitleInput');

            // Set current title value
            modalInput.value = titleElement.textContent;

            // Show modal
            modal.style.display = 'flex';

            // Focus input
            setTimeout(() => modalInput.focus(), 100);
        }

        function closeEditTitleModal() {
            const modal = document.getElementById('editTitleModal');
            modal.style.display = 'none';
        }

        async function saveModalTitle() {
            const modalInput = document.getElementById('modalTitleInput');
            const newTitle = modalInput.value.trim();

            if (!newTitle) {
                showNotification('Title cannot be empty', 'error');
                return;
            }

            const editableField = document.querySelector('.editable-field-title');
            const itemId = editableField.dataset.id;
            const itemType = editableField.dataset.type;

            // Show loading state
            const saveBtn = event.target;
            saveBtn.disabled = true;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('/Vault/UpdateField', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams({
                        id: itemId,
                        itemType: itemType,
                        fieldName: 'Title',
                        fieldValue: newTitle,
                        __RequestVerificationToken: token
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Update title in the page
                    const titleElement = document.querySelector('.item-view-title');
                    titleElement.textContent = newTitle;

                    // Close modal
                    closeEditTitleModal();

                    showNotification('Title updated successfully', 'success');
                } else {
                    showNotification(result.message || 'Failed to update title', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while updating', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEditTitleModal();
            }
        });

        // Close modal on Enter key in input
        document.getElementById('modalTitleInput')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveModalTitle();
            }
        });

        // Enable edit mode for a field
        function enableEdit(btn) {
            const editableField = btn.closest('.editable-field');
            const valueContainer = editableField.querySelector('.field-value-container');
            const editInput = editableField.querySelector('.edit-input');
            const editActions = editableField.querySelector('.edit-actions');


            if (editInput.tagName === 'SELECT') {
                editInput.setAttribute('data-original-value', editInput.value);
            } else {
                editInput.setAttribute('data-original-value', editInput.value);
            }

            valueContainer.style.display = 'none';
            editInput.style.display = 'block';
            editActions.style.display = 'flex';

            if (valueContainer) {
                valueContainer.style.display = 'none';
            }

            if (editableField.classList.contains('editable-field-title')) {
                const titleElement = editableField.querySelector('.item-view-title');
                if (titleElement) {
                    editInput.value = titleElement.textContent;
                    titleElement.style.display = 'none';
                }
            }

            editInput.focus();

            // For textareas, auto-adjust height
            if (editInput.tagName === 'TEXTAREA') {
                editInput.style.height = 'auto';
                editInput.style.height = editInput.scrollHeight + 'px';
            }

            // For select - set current value
            if (editInput.tagName === 'SELECT') {
                const currentValue = editableField.dataset.value || '';
                editInput.value = currentValue;
            }
        }

        // Cancel edit mode
        function cancelEdit(btn) {
            const editableField = btn.closest('.editable-field');
            const valueContainer = editableField.querySelector('.field-value-container');
            const editInput = editableField.querySelector('.edit-input');
            const editActions = editableField.querySelector('.edit-actions');

            // Restore original value
            const originalValue = editInput.getAttribute('data-original-value');
            if (originalValue !== null) {
                editInput.value = originalValue;
            }


            if (editableField.classList.contains('editable-field-title')) {
                const titleElement = editableField.querySelector('.item-view-title');
                if (titleElement) {
                    titleElement.style.display = 'block';
                }
            }

            valueContainer.style.display = 'flex';
            editInput.style.display = 'none';
            editActions.style.display = 'none';
        }

        // Save edited field
        async function saveEdit(btn) {
            const editableField = btn.closest('.editable-field');
            const editInput = editableField.querySelector('.edit-input');
            const fieldValue = editableField.querySelector('.field-value');

            const fieldName = editableField.dataset.field;
            const itemId = editableField.dataset.id;
            const itemType = editableField.dataset.type;

            let newValue = editInput.value;
            let displayValue = newValue;


            if (editInput.tagName === 'SELECT') {
                const selectedOption = editInput.options[editInput.selectedIndex];
                displayValue = selectedOption ? selectedOption.text : 'No Folder';
            }


            if (editInput.tagName === 'TEXTAREA') {
                displayValue = newValue || 'No notes';
            }



            // Show loading state
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = 'Saving...';

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('/Vault/UpdateField', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams({
                        id: itemId,
                        itemType: itemType,
                        fieldName: fieldName,
                        fieldValue: newValue,
                        __RequestVerificationToken: token
                    })
                });

                const result = await response.json();

                if (result.success) {

                    if (fieldValue) {
                        fieldValue.textContent = displayValue;
                    }


                    if (fieldName === 'Title') {
                        const titleElement = editableField.querySelector('.item-view-title');
                        if (titleElement) {
                            titleElement.textContent = newValue;
                            titleElement.style.display = 'block';
                        }
                    }


                    if (fieldName === 'Password') {
                        const toggleBtn = editableField.querySelector('.toggle-password-btn');
                        if (toggleBtn) {
                            toggleBtn.dataset.password = newValue;
                        }
                        editInput.setAttribute('data-actual-value', newValue);


                        const valueSpan = editableField.querySelector('.field-value');
                        if (valueSpan && !valueSpan.classList.contains('password-hidden')) {
                            valueSpan.textContent = newValue;
                        }
                    }


                    if (fieldName === 'FolderId') {
                        editableField.dataset.value = newValue;
                    }

                    cancelEdit(btn);
                    showNotification('Field updated successfully', 'success');
                } else {
                    showNotification(result.message || 'Failed to update field', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('An error occurred while updating', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Toggle password visibility
        function togglePasswordVisibility(btn) {
            const container = btn.closest('.field-value-container');
            const valueSpan = container.querySelector('.field-value');
            const eyeOpen = btn.querySelector('.eye-open');
            const eyeClosed = btn.querySelector('.eye-closed');

            const actualPassword = btn.dataset.password;

            if (valueSpan.classList.contains('password-hidden')) {
                valueSpan.textContent = actualPassword;
                valueSpan.classList.remove('password-hidden');
                eyeOpen.style.display = 'none';
                eyeClosed.style.display = 'block';
            } else {
                valueSpan.textContent = '••••••••••••';
                valueSpan.classList.add('password-hidden');
                eyeOpen.style.display = 'block';
                eyeClosed.style.display = 'none';
            }
        }

        // Format card number (only digits)
        function formatCardNumber(input) {
            let value = input.value.replace(/\D/g, '');
            input.value = value;
        }

        // Format cardholder name (only letters and spaces)
        function formatCardholderName(input) {
            let value = input.value.replace(/[^a-zA-Z\s]/g, '');
            input.value = value;
        }

        // Copy text to clipboard
        function copyToClipboard(text, label) {
            if (!text) return;

            navigator.clipboard.writeText(text).then(() => {
                showNotification(`${label} copied to clipboard!`, 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showNotification('Failed to copy', 'error');
            });
        }

        // Confirm delete action
        function confirmDelete() {
            return confirm('Are you sure you want to delete this item? This action cannot be undone.');
        }

        // Show notification message
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                bottom: 24px;
                right: 24px;
                background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                z-index: 9999;
                animation: slideIn 0.3s ease;
                font-size: 14px;
                font-weight: 500;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Auto-resize textarea on input
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.edit-input-textarea').forEach(textarea => {
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = this.scrollHeight + 'px';
                });
            });
        });
    </script>
}



@section Styles {
    <link rel="stylesheet" href="~/css/view-item.css" asp-append-version="true" />
}
